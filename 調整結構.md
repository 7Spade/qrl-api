# 調整結構計畫（Sequential Thinking）

目標：在不破壞現有功能的前提下，分階段把專案對齊《ARCHITECTURE_TREE.md》《結構.md》《網頁結構.md》。

## 階段 0：準備
- 建立 `src/app` 骨架：interfaces/application/domain/infrastructure/shared/bootstrap.py。
- 設定檔案尺寸準則：單檔 ≦ 4000 字元，預判爆檔先拆。
- 進度：`src/app/*` 已建立空的套件與 `bootstrap.py`；目前執行仍依賴根目錄舊模組，對功能零影響（詳見 `src/app/README.md`）。

## 階段 1：接口層搬遷
- `api/*` → `interfaces/http/*`（保持既有路由與測試）。
- 控制器僅保留 request 轉換與錯誤處理；抽離業務邏輯到 application。
- 進度：新增 `interfaces/http/*` shim，`main.py` 改為透過 shim 匯入既有 router，功能等效且不觸動 handler；Cloud Tasks 路由也透過 `interfaces/tasks/router.py` shim 掛載，與現有行為一致，並移除已無用途的 `infrastructure/cloud_tasks.py`。

## 階段 2：用例層落地
- `services/*`、`repositories/*` → `application/*`，一用例一檔。
- 與 domain 溝通只透過 ports/DTO；避免直接調用 infrastructure。

## 階段 3：Domain 強化
- `domain/interfaces/*` 重命名為 `domain/ports/*`；整理策略/風控/positions。
- 禁止 domain import infrastructure；保持純規則。

## 階段 4：Infrastructure 拆分
- MEXC：依協定拆檔（http/auth/market/account/trade，ws/subscribe_*，adapters，_shared/http_client & parser）。
- Redis：分 connection/codec/keys/repos/locks；一 key pattern 一 repo。
- Bot runtime 與 scheduler 獨立資料夾，僅透過 ports。

## 階段 5：Shared & Cross-cutting
- `utils/*` 精簡為 `shared/`（time/ids/typing），移除肥大 helpers。
- 補充錯誤模型、ID/clock 工具。

## 階段 6：測試與守門
- 單元測試靠近用例與 adapters；接口測試維持在 `tests/`。
- 可新增檔案尺寸/禁止檔名檢查腳本（例如 find src -name \"*.py\" -size +4k）。

## 驗收清單
- 路由全部可在 `interfaces/http` 找到，且不直接觸碰 infrastructure。
- 用例都在 `application`，且依賴 ports 注入 adapters。
- domain 無協定細節；ports 命名清晰。
- MEXC/Redis 檔案按 endpoint/資料型態拆分；無巨型 `client.py`、`core.py`、`utils.py`。
- 主要檔案 ≦ 4000 字元；若超過已有拆分計畫。

## 風險控管
- 每階段完成後跑現有測試；新增路由或移動檔案時保留導向/別名避免中斷。
- 重大搬遷先在 feature 分支驗證，再合併。
