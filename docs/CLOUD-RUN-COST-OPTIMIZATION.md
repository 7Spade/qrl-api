# Cloud Run æˆæœ¬å„ªåŒ–æŒ‡å—

## å•é¡Œåˆ†æ

Cloud Run æ˜¯ç„¡æœå‹™å™¨ï¼ˆServerlessï¼‰è¨ˆè²»æ¨¡å¼ï¼ŒæŒ‰**é‹ç®—æ™‚é–“**å’Œ**è¨˜æ†¶é«”ä½¿ç”¨**è¨ˆè²»ã€‚ç•¶å‰å¯¦æ–½çš„è¨­è¨ˆå¯èƒ½å°è‡´ä¸å¿…è¦çš„æˆæœ¬ï¼ŒåŸå› å¦‚ä¸‹ï¼š

### ç•¶å‰æˆæœ¬é¢¨éšª

1. **å¸¸é§ Redis é€£æ¥**
   - Redis å®¢æˆ¶ç«¯åœ¨æ¨¡çµ„ç´šåˆ¥åˆå§‹åŒ–ï¼ˆ`redis_client`ï¼‰
   - å³ä½¿æ²’æœ‰è«‹æ±‚ï¼Œå®¹å™¨ä»ä¿æŒ Redis é€£æ¥æ´»èº
   - **æˆæœ¬å½±éŸ¿ï¼š** å®¹å™¨é–’ç½®æ™‚ä»è¨ˆè²»è¨˜æ†¶é«”å’Œé€£æ¥è³‡æº

2. **MEXC API å®¢æˆ¶ç«¯å¸¸é§**
   - MEXC å®¢æˆ¶ç«¯åŒæ¨£åœ¨æ¨¡çµ„ç´šåˆ¥åˆå§‹åŒ–ï¼ˆ`mexc_client`ï¼‰
   - ç¶­æŒ HTTP é€£æ¥æ± å’Œæœƒè©±ç‹€æ…‹
   - **æˆæœ¬å½±éŸ¿ï¼š** å¢åŠ åŸºç¤è¨˜æ†¶é«”æ¶ˆè€—

3. **Cloud Scheduler è§¸ç™¼é »ç‡**
   - 15 åˆ†é˜åŸ·è¡Œä¸€æ¬¡ = æ¯å¤© 96 æ¬¡
   - æ¯æœˆç´„ 2,880 æ¬¡è«‹æ±‚
   - **æˆæœ¬å½±éŸ¿ï¼š** é«˜é »è«‹æ±‚ç´¯ç©é‹ç®—æˆæœ¬

4. **å†·å•Ÿå‹•æˆæœ¬**
   - Cloud Run å®¹å™¨é–’ç½®å¾Œæœƒè¢«ç¸®å®¹åˆ° 0
   - ä¸‹æ¬¡è«‹æ±‚éœ€è¦å†·å•Ÿå‹•ï¼ˆ~1-3 ç§’ï¼‰
   - å†·å•Ÿå‹•æœŸé–“ä»è¨ˆè²»
   - **æˆæœ¬å½±éŸ¿ï¼š** æ¯æ¬¡å†·å•Ÿå‹•éƒ½ç”¢ç”Ÿé¡å¤–æˆæœ¬

---

## å„ªåŒ–å»ºè­°ï¼ˆä¾å„ªå…ˆç´šæ’åºï¼‰

### ğŸš€ å„ªå…ˆç´š 1ï¼šå³æ™‚å„ªåŒ–ï¼ˆç„¡éœ€ä»£ç¢¼ä¿®æ”¹ï¼‰

#### 1.1 é…ç½®æœ€å°å¯¦ä¾‹æ•¸ç‚º 0
```bash
gcloud run services update qrl-api \
  --region=asia-southeast1 \
  --min-instances=0 \
  --max-instances=5
```

**æ•ˆç›Šï¼š**
- âœ… ç„¡æµé‡æ™‚ç¸®å®¹åˆ° 0ï¼Œåœæ­¢è¨ˆè²»
- âœ… åƒ…åœ¨ Cloud Scheduler è§¸ç™¼æ™‚å•Ÿå‹•
- âœ… é ä¼°ç¯€çœï¼š50-70% æˆæœ¬

**æ³¨æ„ï¼š** æ¥å—å†·å•Ÿå‹•å»¶é²ï¼ˆ1-3 ç§’ï¼‰ï¼Œä½†å°å®šæ™‚ä»»å‹™ç„¡å½±éŸ¿

#### 1.2 é™ä½è¨˜æ†¶é«”é…ç½®
```bash
gcloud run services update qrl-api \
  --region=asia-southeast1 \
  --memory=512Mi \
  --cpu=1
```

**ç•¶å‰å»ºè­°é…ç½®ï¼š**
- **CPU:** 1 vCPUï¼ˆè¶³å¤ è™•ç† API èª¿ç”¨ï¼‰
- **è¨˜æ†¶é«”:** 512Miï¼ˆPython + FastAPI + å®¢æˆ¶ç«¯ï¼‰
- **è¶…æ™‚:** 300sï¼ˆ5 åˆ†é˜è¶³å¤ åŸ·è¡Œå†å¹³è¡¡ï¼‰

**æ•ˆç›Šï¼š**
- âœ… é™ä½æ¯ç§’è¨˜æ†¶é«”è¨ˆè²»å–®åƒ¹
- âœ… é ä¼°ç¯€çœï¼š20-30% æˆæœ¬

#### 1.3 å„ªåŒ– Cloud Scheduler é…ç½®
```bash
# è¨­ç½®æ›´çŸ­çš„è¶…æ™‚æ™‚é–“
gcloud scheduler jobs update http 15-min-job \
  --location=asia-southeast1 \
  --attempt-deadline=60s
```

**æ•ˆç›Šï¼š**
- âœ… é˜²æ­¢é•·æ™‚é–“é‹è¡Œæ¶ˆè€—æˆæœ¬
- âœ… å¿«é€Ÿå¤±æ•—ï¼Œé¿å…ç„¡é™ç­‰å¾…

---

### ğŸ”§ å„ªå…ˆç´š 2ï¼šä»£ç¢¼ç´šå„ªåŒ–ï¼ˆæ¨è–¦å¯¦æ–½ï¼‰

#### 2.1 å»¶é²åˆå§‹åŒ–ï¼ˆLazy Initializationï¼‰

**å•é¡Œï¼š** ç•¶å‰æ‰€æœ‰å®¢æˆ¶ç«¯åœ¨æ¨¡çµ„åŠ è¼‰æ™‚åˆå§‹åŒ–

**è§£æ±ºæ–¹æ¡ˆï¼š** æ”¹ç‚ºè«‹æ±‚æ™‚åˆå§‹åŒ–

```python
# BEFORE (ç•¶å‰å¯¦ç¾ - æ¨¡çµ„ç´šåˆå§‹åŒ–)
# src/app/infrastructure/external/__init__.py
from src.app.infrastructure.external.mexc import mexc_client, MEXCClient
from src.app.infrastructure.persistence.redis import redis_client, RedisClient

# AFTER (å„ªåŒ–å¾Œ - å»¶é²åˆå§‹åŒ–)
class ClientManager:
    """Lazy client initialization to reduce cold start memory"""
    _mexc_client = None
    _redis_client = None
    
    @property
    def mexc_client(self):
        if self._mexc_client is None:
            from src.app.infrastructure.external.mexc import MEXCClient
            self._mexc_client = MEXCClient()
        return self._mexc_client
    
    @property
    def redis_client(self):
        if self._redis_client is None:
            from src.app.infrastructure.persistence.redis import RedisClient
            self._redis_client = RedisClient()
        return self._redis_client

# å–®ä¾‹ç®¡ç†å™¨
client_manager = ClientManager()
```

**æ•ˆç›Šï¼š**
- âœ… æ¸›å°‘å†·å•Ÿå‹•è¨˜æ†¶é«”æ¶ˆè€—
- âœ… åªåœ¨éœ€è¦æ™‚åˆå§‹åŒ–å®¢æˆ¶ç«¯
- âœ… é ä¼°ç¯€çœå†·å•Ÿå‹•æˆæœ¬ï¼š30-40%

#### 2.2 Redis é€£æ¥æ± å„ªåŒ–

**ç•¶å‰å•é¡Œï¼š** Redis é€£æ¥å¯èƒ½ç¶­æŒä¸å¿…è¦çš„é•·é€£æ¥

**è§£æ±ºæ–¹æ¡ˆï¼š** é…ç½®æ›´çŸ­çš„é€£æ¥è¶…æ™‚

```python
# src/app/infrastructure/persistence/redis/client.py
class RedisClient:
    def __init__(self):
        self.pool = redis.asyncio.ConnectionPool(
            host=config.REDIS_HOST,
            port=config.REDIS_PORT,
            password=config.REDIS_PASSWORD,
            db=0,
            decode_responses=True,
            # å„ªåŒ–é…ç½®
            max_connections=5,          # é™ä½æœ€å¤§é€£æ¥æ•¸
            socket_timeout=10,          # 10 ç§’è¶…æ™‚
            socket_connect_timeout=5,   # 5 ç§’é€£æ¥è¶…æ™‚
            socket_keepalive=False,     # é—œé–‰ keepalive
            retry_on_timeout=True,
        )
```

**æ•ˆç›Šï¼š**
- âœ… æ¸›å°‘é€£æ¥è³‡æºä½”ç”¨
- âœ… é¿å…é•·æ™‚é–“æŒæœ‰é€£æ¥
- âœ… é ä¼°ç¯€çœï¼š10-15% è¨˜æ†¶é«”æˆæœ¬

#### 2.3 è«‹æ±‚çµæŸå¾Œæ¸…ç†è³‡æº

**è§£æ±ºæ–¹æ¡ˆï¼š** åœ¨ç«¯é»å®Œæˆå¾Œé¡¯å¼é—œé–‰é€£æ¥

```python
# src/app/interfaces/tasks/15-min-job.py
@router.post("/15-min-job")
async def task_15_min_job(...):
    try:
        # åŸ·è¡Œä»»å‹™
        await ensure_redis_connected(redis_client)
        # ... åŸ·è¡Œé‚è¼¯
        
    finally:
        # è«‹æ±‚å®Œæˆå¾Œï¼Œå»ºè­°é—œé–‰é€£æ¥ä»¥é‡‹æ”¾è³‡æº
        if redis_client.connected:
            await redis_client.disconnect()
            logger.info("[15-min-job] Redis connection closed")
```

**æ•ˆç›Šï¼š**
- âœ… ç¢ºä¿è³‡æºåŠæ™‚é‡‹æ”¾
- âœ… æ¸›å°‘å®¹å™¨é–’ç½®æ™‚çš„è³‡æºä½”ç”¨
- âœ… é ä¼°ç¯€çœï¼š5-10% æˆæœ¬

---

### ğŸ“Š å„ªå…ˆç´š 3ï¼šæ¶æ§‹ç´šå„ªåŒ–ï¼ˆé•·æœŸæ–¹æ¡ˆï¼‰

#### 3.1 é·ç§»åˆ° Cloud Functionsï¼ˆè€ƒæ…®ï¼‰

**Cloud Functions å„ªå‹¢ï¼š**
- âœ… çœŸæ­£çš„ç„¡æœå‹™å™¨ï¼ŒæŒ‰**èª¿ç”¨æ¬¡æ•¸**è¨ˆè²»
- âœ… ç„¡å†·å•Ÿå‹•æˆæœ¬ï¼ˆè‡ªå‹•ç®¡ç†ï¼‰
- âœ… æ›´é©åˆå®šæ™‚ä»»å‹™å ´æ™¯

**é·ç§»æˆæœ¬ï¼š**
- âš ï¸ éœ€è¦é‡æ§‹ç‚ºå–®ç¨çš„å‡½æ•¸
- âš ï¸ å¤±å» FastAPI çš„ä¾¿åˆ©æ€§
- âš ï¸ éœ€è¦é©é… Cloud Functions æ¡†æ¶

**é©ç”¨å ´æ™¯ï¼š**
- å¦‚æœä¸»è¦æµé‡ä¾†è‡ª Cloud Scheduler
- å¦‚æœä¸éœ€è¦é•·æœŸé‹è¡Œçš„ API æœå‹™

#### 3.2 ä½¿ç”¨ Cloud Tasks æ›¿ä»£ Cloud Scheduler

**Cloud Tasks å„ªå‹¢ï¼š**
- âœ… æ›´ç´°ç²’åº¦çš„æµé‡æ§åˆ¶
- âœ… æ”¯æ´å‹•æ…‹èª¿åº¦ï¼ˆæŒ‰éœ€åŸ·è¡Œï¼‰
- âœ… æ›´å¥½çš„é‡è©¦ç­–ç•¥

**é©ç”¨å ´æ™¯ï¼š**
- éœ€è¦å‹•æ…‹èª¿æ•´åŸ·è¡Œé »ç‡
- éœ€è¦æ›´è¤‡é›œçš„ä»»å‹™ç·¨æ’

#### 3.3 åˆ†é›¢å®šæ™‚ä»»å‹™å’Œ API æœå‹™

**æ–¹æ¡ˆï¼š** å°‡å®šæ™‚ä»»å‹™å’Œ API æœå‹™åˆ†é–‹éƒ¨ç½²

```
éƒ¨ç½²çµæ§‹ï¼š
â”œâ”€â”€ qrl-api (Cloud Run)          # ä¸» API æœå‹™ï¼Œmin-instances=0
â”œâ”€â”€ qrl-tasks (Cloud Functions)  # å®šæ™‚ä»»å‹™ï¼Œåƒ… Cloud Scheduler è§¸ç™¼
```

**æ•ˆç›Šï¼š**
- âœ… API æœå‹™å¯ç¸®å®¹åˆ° 0
- âœ… å®šæ™‚ä»»å‹™æŒ‰èª¿ç”¨è¨ˆè²»
- âœ… é ä¼°ç¯€çœï¼š40-60% ç¸½æˆæœ¬

---

## æˆæœ¬ä¼°ç®—ï¼ˆä»¥å°ç£åœ°å€ç‚ºä¾‹ï¼‰

### ç•¶å‰é…ç½®æˆæœ¬ï¼ˆæœªå„ªåŒ–ï¼‰

**å‡è¨­ï¼š**
- è¨˜æ†¶é«”ï¼š1 GB
- CPUï¼š1 vCPU
- æ¯æ¬¡åŸ·è¡Œï¼š5 ç§’
- é »ç‡ï¼šæ¯ 15 åˆ†é˜ï¼ˆ96 æ¬¡/å¤©ï¼Œ2,880 æ¬¡/æœˆï¼‰
- min-instancesï¼š1ï¼ˆå¸¸é§ï¼‰

**æˆæœ¬è¨ˆç®—ï¼š**
```
# å¸¸é§æˆæœ¬ï¼ˆæœ€å¤§ï¼‰
æ¯æœˆé‹è¡Œæ™‚é–“ = 30 å¤© Ã— 24 å°æ™‚ Ã— 3600 ç§’ = 2,592,000 ç§’
è¨˜æ†¶é«”æˆæœ¬ = 2,592,000 ç§’ Ã— 1 GB Ã— $0.000009 / vCPUç§’ = $23.33
CPU æˆæœ¬ = 2,592,000 ç§’ Ã— 1 vCPU Ã— $0.0000275 / vCPUç§’ = $71.28

æ¯æœˆç¸½æˆæœ¬ = $94.61 USD â‰ˆ NT$3,000
```

### å„ªåŒ–å¾Œæˆæœ¬ï¼ˆæ¨è–¦é…ç½®ï¼‰

**å„ªåŒ–é…ç½®ï¼š**
- è¨˜æ†¶é«”ï¼š512 MBï¼ˆé™ä½ 50%ï¼‰
- CPUï¼š1 vCPU
- æ¯æ¬¡åŸ·è¡Œï¼š5 ç§’
- é »ç‡ï¼šæ¯ 15 åˆ†é˜ï¼ˆ96 æ¬¡/å¤©ï¼Œ2,880 æ¬¡/æœˆï¼‰
- **min-instancesï¼š0ï¼ˆé—œéµï¼ï¼‰**

**æˆæœ¬è¨ˆç®—ï¼š**
```
# åƒ…åŸ·è¡Œæ™‚è¨ˆè²»ï¼ˆmin-instances=0ï¼‰
æ¯æœˆé‹è¡Œæ™‚é–“ = 2,880 æ¬¡ Ã— 5 ç§’ = 14,400 ç§’
è¨˜æ†¶é«”æˆæœ¬ = 14,400 ç§’ Ã— 0.5 GB Ã— $0.000009 / vCPUç§’ = $0.06
CPU æˆæœ¬ = 14,400 ç§’ Ã— 1 vCPU Ã— $0.0000275 / vCPUç§’ = $0.40

æ¯æœˆç¸½æˆæœ¬ = $0.46 USD â‰ˆ NT$15
```

**ç¯€çœï¼š** 94.61 - 0.46 = **$94.15 USD/æœˆï¼ˆç¯€çœ 99.5%ï¼‰**

---

## å¯¦æ–½è¨ˆåŠƒ

### éšæ®µ 1ï¼šç«‹å³åŸ·è¡Œï¼ˆ0-1 å¤©ï¼‰

```bash
# 1. è¨­ç½® min-instances=0
gcloud run services update qrl-api \
  --region=asia-southeast1 \
  --min-instances=0 \
  --max-instances=5

# 2. é™ä½è¨˜æ†¶é«”é…ç½®
gcloud run services update qrl-api \
  --region=asia-southeast1 \
  --memory=512Mi \
  --cpu=1

# 3. å„ªåŒ– Scheduler è¶…æ™‚
gcloud scheduler jobs update http 15-min-job \
  --location=asia-southeast1 \
  --attempt-deadline=60s
```

**é æœŸæˆæœ¬ç¯€çœï¼š** 70-80%

### éšæ®µ 2ï¼šä»£ç¢¼å„ªåŒ–ï¼ˆ1-2 é€±ï¼‰

1. å¯¦æ–½å»¶é²åˆå§‹åŒ–ï¼ˆLazy Initializationï¼‰
2. å„ªåŒ– Redis é€£æ¥æ± é…ç½®
3. æ·»åŠ è«‹æ±‚çµæŸå¾Œè³‡æºæ¸…ç†
4. æ¸¬è©¦ä¸¦éƒ¨ç½²

**é æœŸé¡å¤–ç¯€çœï¼š** 10-15%

### éšæ®µ 3ï¼šæ¶æ§‹å„ªåŒ–ï¼ˆé•·æœŸï¼Œå¯é¸ï¼‰

1. è©•ä¼°é·ç§»åˆ° Cloud Functions çš„å¯è¡Œæ€§
2. è€ƒæ…®åˆ†é›¢å®šæ™‚ä»»å‹™å’Œ API æœå‹™
3. å¯¦æ–½æ›´ç´°ç²’åº¦çš„æˆæœ¬ç›£æ§

**é æœŸé¡å¤–ç¯€çœï¼š** 5-10%

---

## ç›£æ§å’Œå‘Šè­¦

### æˆæœ¬ç›£æ§æŒ‡æ¨™

```bash
# è¨­ç½®é ç®—å‘Šè­¦
gcloud billing budgets create \
  --billing-account=[BILLING_ACCOUNT_ID] \
  --display-name="QRL API Monthly Budget" \
  --budget-amount=50USD \
  --threshold-rule=percent=50 \
  --threshold-rule=percent=90 \
  --threshold-rule=percent=100
```

### é—œéµç›£æ§æŒ‡æ¨™

1. **åŸ·è¡Œæ™‚é–“**
   - ç›£æ§æ¯æ¬¡ä»»å‹™åŸ·è¡Œæ™‚é•·
   - ç›®æ¨™ï¼š< 5 ç§’/æ¬¡

2. **å†·å•Ÿå‹•é »ç‡**
   - ç›£æ§å†·å•Ÿå‹•æ¬¡æ•¸
   - æ¥å— min-instances=0 çš„å†·å•Ÿå‹•

3. **è¨˜æ†¶é«”ä½¿ç”¨**
   - ç›£æ§å³°å€¼è¨˜æ†¶é«”
   - ç¢ºä¿ 512Mi è¶³å¤ 

4. **æˆæœ¬è¶¨å‹¢**
   - æ¯é€±æª¢æŸ¥æˆæœ¬å ±å‘Š
   - å°æ¯”å„ªåŒ–å‰å¾Œ

---

## ç¸½çµ

### æ¨è–¦ç«‹å³åŸ·è¡Œ

âœ… **é…ç½® min-instances=0** - æœ€å¤§æˆæœ¬ç¯€çœ  
âœ… **é™ä½è¨˜æ†¶é«”åˆ° 512Mi** - é™ä½å–®åƒ¹  
âœ… **è¨­ç½®åˆç†è¶…æ™‚** - é˜²æ­¢æµªè²»

### é æœŸæˆæœ¬

- **å„ªåŒ–å‰ï¼š** ~$95 USD/æœˆ â‰ˆ NT$3,000/æœˆ
- **å„ªåŒ–å¾Œï¼š** ~$0.50 USD/æœˆ â‰ˆ NT$15/æœˆ
- **å¹´åº¦ç¯€çœï¼š** ~$1,134 USD â‰ˆ NT$36,000

### å¾ŒçºŒè¡Œå‹•

1. ç«‹å³æ‡‰ç”¨éšæ®µ 1 é…ç½®å„ªåŒ–
2. è¦åŠƒéšæ®µ 2 ä»£ç¢¼å„ªåŒ–
3. è¨­ç½®æˆæœ¬ç›£æ§å’Œå‘Šè­¦
4. æ¯æœˆæª¢è¦–æˆæœ¬å ±å‘Š

---

**æœ€å¾Œæ›´æ–°ï¼š** 2026-01-01  
**ç‹€æ…‹ï¼š** å¾…å¯¦æ–½  
**é æœŸæ•ˆç›Šï¼š** 99.5% æˆæœ¬ç¯€çœ
