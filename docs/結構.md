# 結構基線（依 `ARCHITECTURE_TREE.md` 與 `結構調整.md`）

目標：將現有程式碼逐步遷移到 `src/app` 分層，保持功能等效、檔案小型化（每檔 ≦ 4000 字元，超過需拆分），並避免跨層耦合。
- 進度：`src/app/*` 已建立空骨架與 `bootstrap.py` 佔位；目前執行仍使用根目錄既有模組，未搬動任何邏輯。

## 目錄藍圖（摘要）

```
src/
└── app/
    ├── interfaces/      # HTTP 控制器、任務入口（無業務邏輯）
    ├── application/     # 用例層：每檔一用例，依賴 domain ports
    ├── domain/          # 規則、策略、風控、ports、events
    ├── infrastructure/  # 協定與技術實作：exchange / redis / bot_runtime / scheduler
    ├── shared/          # time/ids/typing 等極小共用件
    └── bootstrap.py     # 唯一黏合點
```

## 現況 → 目標 對應

- `api/` → `interfaces/http/`（控制器只負責 request → usecase，不引入 infrastructure）。
- `services/`、`repositories/` → `application/`（一檔一用例，透過 ports 呼叫依賴）。
- `domain/interfaces/` → `domain/ports/`（定義能力，無協定細節）。
- `infrastructure/external/mexc_client/` → `infrastructure/exchange/mexc/`（http/ws 按 endpoint 拆檔；adapters 實作 ports）。
- `infrastructure/external/redis_client/` → `infrastructure/persistence/redis/`（connection/codec/keys/repos 分層）。
- `utils/` → `shared/`（僅保留 time/ids/typing 等共用元件）。

## 強制邊界

1. HTTP 層不得 import infrastructure。
2. domain 不知道 Redis/MEXC。
3. application 才能呼叫 ports。
4. infrastructure 只實作 ports，不反向依賴 application/domain。
5. `bootstrap.py` 是唯一組裝點。

## 檔案尺寸與命名

- 單檔 ≦ 4000 字元；預計爆檔時應拆分（例如依用例或協定面向）。
- 避免肥檔名：`client.py`、`core.py`、`utils.py`。建議使用行為式檔名：`get_price.py`、`execute_trade.py`。
- Adapters 維持極薄（< 500 行；只做組合與轉換）。

## 遷移提示

- 先建立目標目錄骨架，再逐路徑移動：`api` → `interfaces/http`、`services`/`repositories` → `application`。
- MEXC：一個 endpoint/WS channel 一個檔案；共用 http_client/parser 放在 `_shared/`。
- Redis：依 key pattern 拆成單一 repo；分離 connection/codec/keys/locks。
- 測試靠近用例與 adapters；重用 `tests/` 現有資料夾可先行。

相關細節請搭配《網頁結構.md》《調整結構.md》。
